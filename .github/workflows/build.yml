name: Build IPA
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      # 1. 生成 iOS 项目
      - name: Create iOS folders
        run: flutter create .

      # 2. 【核心】使用 Python 脚本精准修改项目配置
      # 相比 sed 命令，这种方式更稳定，不会因为空格或格式问题失败
      - name: Patch Xcode Project with Python
        run: |
          python3 -c "
          import sys
          
          file_path = 'ios/Runner.xcodeproj/project.pbxproj'
          
          with open(file_path, 'r') as file:
              content = file.read()
          
          # 1. 强制改为手动签名 (Manual)
          content = content.replace('ProvisioningStyle = Automatic;', 'ProvisioningStyle = Manual;')
          
          # 2. 暴力移除开发团队 ID (支持多种格式)
          import re
          # 删除 DevelopmentTeam = XXXXX; 这一行
          content = re.sub(r'DevelopmentTeam = [^;]*;', 'DevelopmentTeam = \"\";', content)
          
          # 3. 强制关闭签名要求
          content = content.replace('CODE_SIGNING_REQUIRED = YES;', 'CODE_SIGNING_REQUIRED = NO;')
          content = content.replace('CODE_SIGNING_ALLOWED = YES;', 'CODE_SIGNING_ALLOWED = NO;')
          
          with open(file_path, 'w') as file:
              file.write(content)
          
          print('✅ Python 脚本：已强制修改 Xcode 项目文件！')
          "

      # 3. 双重保险：修改 Flutter 配置文件
      - name: Patch XCConfig
        run: |
          CONFIG="ios/Flutter/Release.xcconfig"
          echo "CODE_SIGNING_ALLOWED=NO" >> $CONFIG
          echo "CODE_SIGNING_REQUIRED=NO" >> $CONFIG
          echo "CODE_SIGN_IDENTITY=" >> $CONFIG
          echo "EXPANDED_CODE_SIGN_IDENTITY=" >> $CONFIG

      - run: flutter pub get
      
      # 4. 打包
      - run: flutter build ios --release --no-codesign
      
      # 5. 生成 IPA
      - run: |
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload/
          zip -r GlassFund.ipa Payload
          
      - uses: actions/upload-artifact@v4
        with:
          name: GlassFund-App
          path: GlassFund.ipa
