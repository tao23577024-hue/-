name: Build IPA
on: [push, workflow_dispatch]

jobs:
  build:
    # 必须使用最新系统，因为 macos-13 已经被 GitHub 下架了
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      # 1. 生成 iOS 项目骨架
      - name: Create iOS folders
        run: flutter create .

      # 2. 【核弹级】彻底粉碎签名要求 (适配最新 Xcode)
      - name: Nuke Signing Requirements
        run: |
          # 找到项目文件路径
          PBX="ios/Runner.xcodeproj/project.pbxproj"
          
          # A. 暴力移除“开发团队”字段
          sed -i '' 's/DevelopmentTeam = .*/DevelopmentTeam = "";/g' $PBX
          
          # B. 强制改为“手动签名”模式
          sed -i '' 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g' $PBX
          
          # C. 在项目级别强制关闭签名
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES;/CODE_SIGNING_REQUIRED = NO;/g' $PBX
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES;/CODE_SIGNING_ALLOWED = NO;/g' $PBX
          
          # D. 【最关键一步】向 Flutter 配置文件注入“禁止签名”指令
          # 这会覆盖掉 Xcode 的默认设置
          CONFIG="ios/Flutter/Release.xcconfig"
          echo "" >> $CONFIG
          echo "CODE_SIGNING_REQUIRED=NO" >> $CONFIG
          echo "CODE_SIGNING_ALLOWED=NO" >> $CONFIG
          echo "CODE_SIGN_IDENTITY=" >> $CONFIG
          echo "EXPANDED_CODE_SIGN_IDENTITY=" >> $CONFIG

      - run: flutter pub get
      
      # 3. 打包
      - run: flutter build ios --release --no-codesign
      
      # 4. 生成文件
      - run: |
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload/
          zip -r GlassFund.ipa Payload
          
      - uses: actions/upload-artifact@v4
        with:
          name: GlassFund-App
          path: GlassFund.ipa
