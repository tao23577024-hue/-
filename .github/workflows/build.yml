name: Build IPA
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      # 1. 生成项目
      - name: Create iOS folders
        run: flutter create .

      # 2. 【核心】使用 Python 实施“伪造签名”欺骗战术
      - name: Fake Signing Setup
        run: |
          python3 -c "
          import re
          
          file_path = 'ios/Runner.xcodeproj/project.pbxproj'
          with open(file_path, 'r') as file:
              content = file.read()
          
          # 1. 将 'Automatic' 替换为 'Manual' (忽略空格差异)
          content = re.sub(r'ProvisioningStyle\s*=\s*Automatic;', 'ProvisioningStyle = Manual;', content)
          
          # 2. 删除 DevelopmentTeam (整行删除)
          content = re.sub(r'DevelopmentTeam\s*=\s*[^;]*;', 'DevelopmentTeam = \"\";', content)
          
          # 3. 关键：将签名身份改为 '-' (Ad Hoc 伪签名)，骗过 Xcode
          content = re.sub(r'CODE_SIGN_IDENTITY\s*=\s*\"iPhone Developer\";', 'CODE_SIGN_IDENTITY = \"-\";', content)
          content = re.sub(r'\"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\"\s*=\s*\"iPhone Developer\";', '\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"-\";', content)
          
          # 4. 关闭强制签名要求
          content = re.sub(r'CODE_SIGNING_REQUIRED\s*=\s*YES;', 'CODE_SIGNING_REQUIRED = NO;', content)
          content = re.sub(r'CODE_SIGNING_ALLOWED\s*=\s*YES;', 'CODE_SIGNING_ALLOWED = NO;', content)
          
          with open(file_path, 'w') as file:
              file.write(content)
          print('✅ Python：已完成伪签名配置！')
          "

      # 3. 双重保险：修改 Flutter 配置文件，注入伪签名
      - name: Patch XCConfig
        run: |
          CONFIG="ios/Flutter/Release.xcconfig"
          echo "CODE_SIGN_IDENTITY=-" >> $CONFIG
          echo "CODE_SIGNING_REQUIRED=NO" >> $CONFIG
          echo "CODE_SIGNING_ALLOWED=NO" >> $CONFIG

      # 4. 三重保险：修改 Podfile，让第三方库也不要签名
      - name: Patch Podfile
        run: |
          # 向 ios/Podfile 尾部追加一段 Ruby 代码，强制关闭所有 Pod 的签名
          cat <<EOF >> ios/Podfile
          
          post_install do |installer|
            installer.pods_project.targets.each do |target|
              target.build_configurations.each do |config|
                config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
                config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
                config.build_settings['EXPANDED_CODE_SIGN_IDENTITY'] = '-'
              end
            end
          end
          EOF

      - run: flutter pub get
      
      # 5. 打包 (带上 --no-codesign)
      - run: flutter build ios --release --no-codesign
      
      # 6. 生成 IPA
      - run: |
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload/
          zip -r GlassFund.ipa Payload
          
      - uses: actions/upload-artifact@v4
        with:
          name: GlassFund-App
          path: GlassFund.ipa
