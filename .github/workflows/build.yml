name: Build IPA
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      # 1. 生成 iOS 项目骨架
      - name: Create iOS folders
        run: flutter create .

      # 2. 【双重暴力修复】禁止 Xcode 检查签名
      - name: Force Disable Signing
        run: |
          # 方案 A: 修改 Flutter 的配置文件 (这是最高优先级的覆盖)
          # 告诉 Flutter：不需要签名，也不允许签名
          echo "CODE_SIGNING_REQUIRED=NO" >> ios/Flutter/Release.xcconfig
          echo "CODE_SIGNING_ALLOWED=NO" >> ios/Flutter/Release.xcconfig
          echo "CODE_SIGN_IDENTITY=" >> ios/Flutter/Release.xcconfig
          echo "EXPANDED_CODE_SIGN_IDENTITY=" >> ios/Flutter/Release.xcconfig
          
          # 方案 B: 直接修改 Xcode 项目文件
          # 1. 把“自动签名”改成“手动签名”
          sed -i '' 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g' ios/Runner.xcodeproj/project.pbxproj
          # 2. 把“开发团队 ID”清空
          sed -i '' 's/DevelopmentTeam = [^;]*;/DevelopmentTeam = "";/g' ios/Runner.xcodeproj/project.pbxproj

      - run: flutter pub get
      
      # 3. 打包
      - run: flutter build ios --release --no-codesign
      
      # 4. 压缩成 IPA
      - run: |
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload/
          zip -r GlassFund.ipa Payload
          
      - uses: actions/upload-artifact@v4
        with:
          name: GlassFund-App
          path: GlassFund.ipa
