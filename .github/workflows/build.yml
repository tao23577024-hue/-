name: Build IPA
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      # 1. 生成 iOS 项目
      - name: Create iOS folders
        run: flutter create .

      # 2. 【核弹级】修改 Xcode 项目配置
      - name: Nuke Signing Requirements
        run: |
          echo "正在执行暴力免签操作..."
          
          # 定义文件路径
          PBX="ios/Runner.xcodeproj/project.pbxproj"
          XCCONFIG="ios/Flutter/Release.xcconfig"
          
          # A. 修改 project.pbxproj (项目主文件)
          # 1. 把“自动签名”改成“手动”
          sed -i '' 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g' $PBX
          # 2. 直接删除 DevelopmentTeam 这一行 (无论它后面是什么)
          sed -i '' '/DevelopmentTeam/d' $PBX
          # 3. 强制关闭签名要求
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES;/CODE_SIGNING_REQUIRED = NO;/g' $PBX
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES;/CODE_SIGNING_ALLOWED = NO;/g' $PBX
          
          # B. 修改 Release.xcconfig (Flutter 配置文件)
          # 追加强制覆盖配置
          echo "" >> $XCCONFIG
          echo "CODE_SIGNING_ALLOWED=NO" >> $XCCONFIG
          echo "CODE_SIGNING_REQUIRED=NO" >> $XCCONFIG
          echo "CODE_SIGN_IDENTITY=" >> $XCCONFIG
          echo "EXPANDED_CODE_SIGN_IDENTITY=" >> $XCCONFIG
          
          echo "暴力免签操作完成！"

      - run: flutter pub get
      
      # 3. 打包 (带上 --no-codesign)
      - run: flutter build ios --release --no-codesign
      
      # 4. 压缩生成 IPA
      - run: |
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload/
          zip -r GlassFund.ipa Payload
          
      - uses: actions/upload-artifact@v4
        with:
          name: GlassFund-App
          path: GlassFund.ipa
