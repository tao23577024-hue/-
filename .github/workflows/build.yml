name: Build IPA
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      # 1. 生成项目
      - name: Create iOS folders
        run: flutter create .

      # 2. 【核心修复】将签名模式强制改为“手动”
      - name: Force Manual Signing
        run: |
          # 定义项目文件路径
          PBX="ios/Runner.xcodeproj/project.pbxproj"
          
          # 1. 把所有 "ProvisioningStyle = Automatic" 替换为 "Manual"
          # 注意：这里去掉了分号，以防格式差异匹配不到
          sed -i '' 's/ProvisioningStyle = Automatic/ProvisioningStyle = Manual/g' $PBX
          
          # 2. 强制关闭签名检查 (向项目文件里注入 "NO")
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES/CODE_SIGNING_REQUIRED = NO/g' $PBX
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g' $PBX
          
          # 3. 再次向 Flutter 配置里写入“禁止签名”
          CONFIG="ios/Flutter/Release.xcconfig"
          echo "CODE_SIGNING_ALLOWED=NO" >> $CONFIG
          echo "CODE_SIGNING_REQUIRED=NO" >> $CONFIG
          echo "CODE_SIGN_IDENTITY=" >> $CONFIG
          echo "EXPANDED_CODE_SIGN_IDENTITY=" >> $CONFIG
          
          echo "已强制修改为手动签名模式！"

      - run: flutter pub get
      
      # 3. 打包
      - run: flutter build ios --release --no-codesign
      
      # 4. 生成文件
      - run: |
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload/
          zip -r GlassFund.ipa Payload
          
      - uses: actions/upload-artifact@v4
        with:
          name: GlassFund-App
          path: GlassFund.ipa
